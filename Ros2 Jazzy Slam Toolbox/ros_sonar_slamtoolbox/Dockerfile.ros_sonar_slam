# ---------------------------------------------------------
# Base: ROS 2 Jazzy (Ubuntu 24.04)
# ---------------------------------------------------------
FROM ros_jazzy_base

ENV DEBIAN_FRONTEND=noninteractive

# ---------------------------------------------------------
# Fix Ubuntu + ROS keyrings (Noble key rotation)
# ---------------------------------------------------------
RUN apt-get update || true && \
    apt-get install -y --reinstall --no-install-recommends \
        ubuntu-keyring \
        debian-archive-keyring \
        ca-certificates && \
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
        -o /usr/share/keyrings/ros-archive-keyring.gpg && \
    rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------
# Install dependencies (CMake-based ROS package)
# ---------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip python3-colcon-common-extensions git \
    ros-jazzy-rosidl-default-generators \
    ros-jazzy-rclpy \
    ros-jazzy-geometry-msgs \
    ros-jazzy-nav-msgs \
    ros-jazzy-sensor-msgs \
    ros-jazzy-std-msgs \
    ros-jazzy-std-srvs \
    ros-jazzy-tf2 \
    ros-jazzy-tf2-ros \
    ros-jazzy-tf2-geometry-msgs \
    ros-jazzy-slam-toolbox \
    libboost-thread-dev \
    libboost-filesystem-dev \
    libboost-system-dev \
    libboost-chrono-dev \
    && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------
# Create ROS workspace
# ---------------------------------------------------------
RUN mkdir -p /opt/ros_ws/src
WORKDIR /opt/ros_ws

# ---------------------------------------------------------
# Python utilities (outside ROS workspace)
# ---------------------------------------------------------
COPY ./python_utils/ros_sonar_py /opt/python_utils/ros_sonar_py
ENV PYTHONPATH="/opt/python_utils:${PYTHONPATH}"

COPY ./python /opt/python_app
RUN pip install -r /opt/python_app/requirements.txt --break-system-packages

# ---------------------------------------------------------
# Copy ROS package (CMake-based)
# ---------------------------------------------------------
COPY ./ros_ws/src/ros_sonar /opt/ros_ws/src/ros_sonar

RUN find /opt/ros_ws -name COLCON_IGNORE -print -delete

RUN echo "=== ros_sonar package inside container ===" && \
    ls -R /opt/ros_ws/src/ros_sonar

# ---------------------------------------------------------
# rosdep
# ---------------------------------------------------------
RUN /bin/bash -c "source /opt/ros/jazzy/setup.bash && \
    rosdep update && \
    rosdep install --from-paths src --ignore-src -y"

# ---------------------------------------------------------
# Build workspace (CMake package)
# ---------------------------------------------------------
RUN /bin/bash -c "source /opt/ros/jazzy/setup.bash && \
    rm -rf build install log && \
    colcon build --symlink-install"

ENV ROS_DOMAIN_ID=0

# ---------------------------------------------------------
# Auto-source workspace
# ---------------------------------------------------------
RUN printf '%s\n' \
"source /opt/ros/jazzy/setup.bash" \
"source /opt/ros_ws/install/setup.bash" \
>> /etc/bash.bashrc

RUN printf '%s\n' \
"source /opt/ros/jazzy/setup.bash" \
"source /opt/ros_ws/install/setup.bash" \
>> /root/.bashrc

CMD ["/bin/bash"]

