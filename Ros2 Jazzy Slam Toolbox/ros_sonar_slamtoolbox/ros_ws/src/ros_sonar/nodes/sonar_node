#!/usr/bin/env python3
import math
import rclpy
from rclpy.node import Node

from ros_sonar.msg import SonarScan
from sensor_msgs.msg import LaserScan
from ros_sonar_py.sonar import Sonar

class SonarNode(Node):
    def __init__(self):
        super().__init__("sonar_node")

        # Parameters
        self.min_angle = self.declare_parameter("min_angle", 0.0).value
        self.max_angle = self.declare_parameter("max_angle", 180.0).value
        self.step = self.declare_parameter("step", 2.0).value
        self.settle_sec = self.declare_parameter("settle_sec", 0.15).value
        self.period_sec = self.declare_parameter("period_sec", 6.0).value

        # Sonar hardware abstraction
        self.sonar = Sonar(self.min_angle, self.max_angle, self.step, self.settle_sec)

        # Pre-allocate ranges list
        self.num_points = int((self.max_angle - self.min_angle) / self.step) + 1
        self.ranges = [float("inf")] * self.num_points

        # Publishers
        self.pub_scan = self.create_publisher(SonarScan, "sonar_scan", 10)
        self.pub_scan_laser = self.create_publisher(LaserScan, "scan", 10)

        # Timer
        self.timer = self.create_timer(self.period_sec, self._on_timer)

    def _on_timer(self):
        angles, distances = self.sonar.sweep()

        if len(angles) < 10:
            self.get_logger().warn("Sweep aborted early")
            return

        # Publish custom SonarScan
        msg = SonarScan()
        msg.angles = angles
        msg.distances = distances
        self.pub_scan.publish(msg)

        # Publish LaserScan
        laser = LaserScan()
        laser.header.stamp = self.get_clock().now().to_msg()
        laser.header.frame_id = "sonar_link"

        laser.angle_min = -math.pi / 2      # -90 deg
        laser.angle_max =  math.pi / 2      # +90 deg
        laser.angle_increment = math.radians(self.step)

        laser.range_min = 0.05
        laser.range_max = 5.0

        laser.scan_time = 0.1               # NOT 6.0
        laser.time_increment = 0.0

        laser.ranges = self.ranges

        # Fill pre-allocated ranges
        for i, d in enumerate(distances):
            self.ranges[i] = float(d) if d > 0.0 else float("inf")

        laser.ranges = self.ranges
        self.pub_scan_laser.publish(laser)

def main(args=None):
    rclpy.init(args=args)
    node = SonarNode()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()

if __name__ == "__main__":
    main()

